# Docs: https://github.com/Azure/webapps-deploy
# More Azure Actions: https://github.com/Azure/actions

name: CI/CD Completo - SAST + BDD + SCA + Deploy + DAST

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

env:
  JAVA_VERSION: '21'
  DISTRIBUTION: 'temurin'
  SONAR_HOST_URL: 'https://sonarcloud.io'
  SONAR_PROJECT_KEY: 'SebasMa24_Taller1'
  SONAR_ORGANIZATION: 'sebasma24'
  AZURE_APP_NAME: 'Actividad5'
  SLOT_NAME: 'Production'

# ======================================================================
# 1. SAST – ANÁLISIS ESTÁTICO (SonarCloud)
# ======================================================================
jobs:
  sast_sonarcloud:
    name: SAST - SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Static Analysis with SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B -ntp clean verify \
            org.jacoco:jacoco-maven-plugin:report \
            org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.organization=${{ env.SONAR_ORGANIZATION }} \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}

# ======================================================================
# 2. BDD – PRUEBAS CUCUMBER
# ======================================================================
  bdd_tests:
    name: BDD - Cucumber Tests
    runs-on: ubuntu-latest
    needs: sast_sonarcloud

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ env.DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Run Cucumber Tests
        run: |
          mvn -B -ntp verify \
            -Dcucumber.options="--plugin json:target/cucumber.json --plugin html:target/cucumber-report.html"

      - name: Upload Cucumber Reports
        if: hashFiles('target/cucumber.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-reports
          path: |
            target/cucumber.json
            target/cucumber-report.html

# ======================================================================
# 3. BUILD & DEPLOY – SOLO EN ESTA ETAPA SE GENERA EL .JAR
# ======================================================================
  package_and_deploy:
    name: Build & Deploy to Azure
    runs-on: ubuntu-latest
    needs: bdd_tests

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      # Solo aquí se construye el .jar
      - name: Build JAR (skip tests)
        run: mvn -B -DskipTests clean package

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: java-app
          path: target/*.jar

      - name: Download JAR for Deploy
        uses: actions/download-artifact@v4
        with:
          name: java-app
          path: java-app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_47751D3BEE7A455B97BDCF3BFB149319 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_5671D8C89CEC47A0952FA9BA546DF435 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_5D87480D0A5B4C3DA6B5313A595E0865 }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          slot-name: ${{ env.SLOT_NAME }}
          package: "java-app/*.jar"

# ======================================================================
# 4. DAST – ANÁLISIS DINÁMICO (OWASP ZAP)
# ======================================================================
  dynamic_analysis:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: package_and_deploy

    permissions:
      contents: write
      actions: write
      security-events: write

    steps:
      - name: ZAP Baseline Scan without artifact
        continue-on-error: true
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "https://actividad5-f5dvbrbrdqfqaxbg.eastus2-01.azurewebsites.net"
          cmd_options: "-a --autooff -I -r zap-report.html"
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact_name: "zap-report" 
          allow_issue_writing: false
          fail_action: false

      - name: Upload manually generated report
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-scan-report
          path: zap-report.html
          retention-days: 30









